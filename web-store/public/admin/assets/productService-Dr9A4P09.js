import{s as c}from"./index-B7VyGmnV.js";async function f(t){const r=t?.page??1,o=t?.limit,a=(r-1)*o;let e=c.from("products").select("*, category:categories(id, name, slug)",{count:"exact"});t?.search&&(e=e.ilike("name",`%${t.search}%`)),t?.category_id&&(e=e.eq("category_id",t.category_id)),t?.is_active!==void 0&&(e=e.eq("is_active",t.is_active)),e=e.order("created_at",{ascending:!1}).range(a,a+o-1);const{data:s,error:i,count:d}=await e;if(i)throw i;return{data:s??[],count:d??0}}async function l(t){const{data:r,error:o}=await c.from("products").select("*, category:categories(*)").eq("id",t).single();if(o)throw o;return r}async function g(t){const{data:r,error:o}=await c.from("products").insert(t).select().single();if(o)throw o;return r}async function p(t,r){const{data:o,error:a}=await c.from("products").update({...r,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(a)throw a;return o}async function m(t){const r=c,{data:o}=await r.from("products").select("images").eq("id",t).single(),{error:a}=await r.from("products").delete().eq("id",t);if(a){if(a.code==="23503"){const{error:e}=await r.from("products").update({is_active:!1}).eq("id",t);throw e||new Error("Product is linked to existing orders. It has been deactivated instead to preserve order history.")}throw console.error("Delete product error:",a),a}if(o?.images)for(const e of o.images)try{await n(e)}catch(s){console.warn("Failed to delete image:",e,s)}}async function w(){const t=c,{data:r,error:o}=await t.from("products").select("id, images");if(o)throw o;if(!r||r.length===0)return;const{error:a}=await t.from("products").delete().gte("id","00000000-0000-0000-0000-000000000000");if(a){if(a.code==="23503"){const{error:e}=await t.from("products").update({is_active:!1}).neq("is_active",!1);throw e||new Error("Some products are linked to orders and cannot be deleted. All products have been deactivated instead.")}throw a}for(const e of r)if(e.images)for(const s of e.images)try{await n(s)}catch(i){console.warn("Failed to delete image:",s,i)}}async function h(t,r){const o=t.name.split(".").pop(),a=`${r}/${Date.now()}.${o}`,{error:e}=await c.storage.from("product-images").upload(a,t,{upsert:!0});if(e)throw e;const{data:s}=c.storage.from("product-images").getPublicUrl(a);return s.publicUrl}async function n(t){const r=t.split("/product-images/")[1];r&&await c.storage.from("product-images").remove([r])}export{w as a,l as b,h as c,m as d,g as e,f as g,p as u};
